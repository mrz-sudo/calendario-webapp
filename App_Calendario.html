<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Interattivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        .initial-state-container {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background-color: #f3f4f6;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
            text-align: center;
        }

        .initial-state-container p {
            color: #4b5563;
        }

        .loader {
            height: 3rem;
            width: 3rem;
            margin-bottom: 1rem;
            border: 4px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @media (prefers-color-scheme: dark) {
            .initial-state-container {
                background-color: #111827;
            }

            .initial-state-container p {
                color: #d1d5db;
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .calendar-container {
            user-select: none;
        }

        .day-cell {
            position: relative;
            transition: transform 0.1s ease-in-out;
        }

        .day-cell::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 3px solid #3b82f6;
            border-radius: 0.5rem;
            opacity: 0;
            transition: opacity 0.1s ease-in-out;
            pointer-events: none;
        }

        .day-cell:active {
            transform: scale(0.95);
        }

        .modal-content {
            animation: slide-up 0.3s ease-out;
        }

        @keyframes slide-up {
            from {
                transform: translateY(30px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }


        .line-clamp-2 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
        }

        .day-selected {
            transform: scale(0.9);
        }

        .day-selected::after {
            opacity: 1;
        }

        .dropdown-content {
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
    </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900">

    <div id="initial-loader" class="initial-state-container">
        <div class="loader"></div>
        <p>Caricamento in corso...</p>
    </div>

    <div id="error-container" class="initial-state-container" style="display: none;"></div>

    <main id="app-container" class="hidden">
        <div id="monthly-view" class="p-4">
            <div class="w-full max-w-4xl mx-auto bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-4 sm:p-6">
                <div class="flex flex-wrap sm:flex-nowrap justify-between items-center mb-6 gap-4">
                    <h1 id="month-year"
                        class="w-full sm:w-auto text-center sm:text-left text-xl sm:text-2xl font-bold text-gray-800 dark:text-gray-200 flex-shrink-0 order-1 sm:order-1">
                    </h1>
                    <div id="controls-month-wrapper" class="w-full sm:w-auto order-2 sm:order-2">
                        <div id="management-buttons-month"
                            class="hidden w-full flex items-center justify-end space-x-2">
                            <button id="cancel-selection-btn-month"
                                class="text-sm font-semibold text-red-600 bg-red-100 hover:bg-red-200 px-4 py-2 rounded-full">Annulla</button>
                            <button id="proceed-selection-btn-month" disabled
                                class="text-sm font-semibold text-white bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed px-4 py-2 rounded-full">Procedi</button>
                        </div>
                        <div id="navigation-buttons-month" class="flex items-center sm:justify-end gap-2">
                            <div class="flex-1 sm:hidden"></div>
                            <div class="flex items-center space-x-2">
                                <button id="prev-month-btn"
                                    class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><svg
                                        class="w-6 h-6 text-gray-600 dark:text-gray-400" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 19l-7-7 7-7"></path>
                                    </svg></button>
                                <button id="today-month-btn"
                                    class="text-sm font-semibold text-blue-600 bg-blue-100 hover:bg-blue-200 dark:bg-blue-300 dark:text-blue-800 dark:hover:bg-blue-400 px-4 py-2 rounded-full">Oggi</button>
                                <button id="next-month-btn"
                                    class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><svg
                                        class="w-6 h-6 text-gray-600 dark:text-gray-400" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 5l7 7-7 7"></path>
                                    </svg></button>
                            </div>
                            <div class="relative flex-1 sm:flex-initial flex justify-end">
                                <button id="menu-month-btn"
                                    class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                                    <svg class="w-6 h-6 text-gray-600 dark:text-gray-400" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 6h16M4 12h16M4 18h16"></path>
                                    </svg>
                                </button>
                                <div id="menu-month-content"
                                    class="dropdown-content absolute right-0 top-full mt-2 w-48 bg-white dark:bg-gray-700 rounded-md shadow-lg py-1 z-20 hidden transform opacity-0 scale-95">
                                    <a href="#" id="manage-btn-month"
                                        class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Gestisci</a>
                                    <a href="#" id="summary-btn"
                                        class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Riepilogo
                                        Riposi</a>
                                    <a href="#" id="settings-btn-month"
                                        class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Impostazioni</a>
                                    <a href="#" id="toggle-to-annual-view"
                                        class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Vista
                                        Annuale</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="calendar-container">
                    <div
                        class="grid grid-cols-7 gap-1 text-center text-xs font-semibold text-gray-500 dark:text-gray-400 mb-2">
                        <div>LUN</div>
                        <div>MAR</div>
                        <div>MER</div>
                        <div>GIO</div>
                        <div>VEN</div>
                        <div>SAB</div>
                        <div>DOM</div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 auto-rows-fr gap-1"></div>
                </div>
            </div>
        </div>

        <div id="annual-view" class="hidden p-4">
            <div class="w-full max-w-7xl mx-auto bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-4 sm:p-6">
                <div class="flex flex-wrap sm:flex-nowrap justify-between items-center mb-4 gap-4">
                    <h1 id="year-title"
                        class="w-full sm:w-auto text-center sm:text-left text-2xl font-bold text-gray-800 dark:text-gray-200 flex-shrink-0 order-1 sm:order-1">
                    </h1>
                    <div id="controls-year-wrapper" class="w-full sm:w-auto order-2 sm:order-2">
                        <div id="management-buttons-year" class="hidden w-full flex items-center justify-end space-x-2">
                            <button id="cancel-selection-btn-year"
                                class="text-sm font-semibold text-red-600 bg-red-100 hover:bg-red-200 px-4 py-2 rounded-full">Annulla</button>
                            <button id="proceed-selection-btn-year" disabled
                                class="text-sm font-semibold text-white bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed px-4 py-2 rounded-full">Procedi</button>
                        </div>
                        <div id="navigation-buttons-year" class="flex items-center sm:justify-end gap-2">
                            <div class="flex-1 sm:hidden"></div>
                            <div class="flex items-center space-x-2">
                                <button id="prev-year-btn"
                                    class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><svg
                                        class="w-6 h-6 text-gray-600 dark:text-gray-400" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 19l-7-7 7-7"></path>
                                    </svg></button>
                                <button id="today-year-btn"
                                    class="text-sm font-semibold text-blue-600 bg-blue-100 hover:bg-blue-200 dark:bg-blue-300 dark:text-blue-800 dark:hover:bg-blue-400 px-4 py-2 rounded-full">Anno
                                    attuale</button>
                                <button id="next-year-btn"
                                    class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><svg
                                        class="w-6 h-6 text-gray-600 dark:text-gray-400" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 5l7 7-7 7"></path>
                                    </svg></button>
                            </div>
                            <div class="relative flex-1 sm:flex-initial flex justify-end">
                                <button id="menu-year-btn"
                                    class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                                    <svg class="w-6 h-6 text-gray-600 dark:text-gray-400" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 6h16M4 12h16M4 18h16"></path>
                                    </svg>
                                </button>
                                <div id="menu-year-content"
                                    class="dropdown-content absolute right-0 top-full mt-2 w-48 bg-white dark:bg-gray-700 rounded-md shadow-lg py-1 z-20 hidden transform opacity-0 scale-95">
                                    <a href="#" id="manage-btn-year"
                                        class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Gestisci</a>
                                    <a href="#" id="summary-btn-year"
                                        class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Riepilogo
                                        Riposi</a>
                                    <a href="#" id="settings-btn-year"
                                        class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Impostazioni</a>
                                    <a href="#" id="toggle-to-monthly-view"
                                        class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Vista
                                        Mensile</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="year-grid"
                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 max-w-7xl mx-auto"></div>
            </div>
        </div>

        <div id="summary-view" class="hidden p-4">
            <div class="w-full max-w-4xl mx-auto bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-4 sm:p-6">
                <div class="flex justify-between items-center mb-6 gap-4">
                    <h1 class="text-xl sm:text-2xl font-bold text-gray-800 dark:text-gray-200">Riepilogo Riposi AC</h1>
                    <div class="flex items-center gap-2">
                        <button id="back-to-calendar-btn"
                            class="text-sm font-semibold text-blue-600 bg-blue-100 hover:bg-blue-200 px-4 py-2 rounded-full">Indietro</button>
                        <div class="relative">
                            <button id="menu-summary-btn"
                                class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                                <svg class="w-6 h-6 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 6h16M4 12h16M4 18h16"></path>
                                </svg>
                            </button>
                            <div id="menu-summary-content"
                                class="dropdown-content absolute right-0 top-full mt-2 w-48 bg-white dark:bg-gray-700 rounded-md shadow-lg py-1 z-20 hidden transform opacity-0 scale-95">
                                <a href="#" id="edit-summary-btn"
                                    class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Modifica
                                    dati</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <div id="summary-content"></div>
                </div>
                <div id="summary-notices" class="mt-4 space-y-2"></div>
            </div>
        </div>
    </main>



    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-lg p-6 flex flex-col"
            style="max-height: 90vh;">
            <div class="flex-shrink-0">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-800 dark:text-gray-200">Impostazioni Tipi Evento</h2>
                    <button id="close-settings-modal-btn"
                        class="p-2 -mt-2 -mr-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg class="w-6 h-6 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <div id="settings-event-list" class="flex-grow overflow-y-auto pr-2 space-y-3">
            </div>

            <div id="settings-loading" class="hidden text-center p-8">
                <div class="loader mx-auto"></div>
                <p class="text-gray-600 dark:text-gray-300 mt-4">Salvataggio in corso...</p>
            </div>

            <div id="settings-buttons" class="flex-shrink-0 pt-4 mt-4 border-t border-gray-200 dark:border-gray-700">
                <div class="flex flex-col sm:flex-row sm:justify-between items-center gap-3">

                    <button id="add-event-type-btn"
                        class="w-full sm:w-auto px-4 py-2 rounded-lg text-sm font-semibold text-blue-600 bg-blue-100 hover:bg-blue-200">Aggiungi
                        Evento</button>

                    <div class="flex w-full sm:w-auto justify-center sm:justify-end space-x-3">
                        <button id="cancel-settings-btn"
                            class="px-4 py-2 rounded-lg text-sm font-semibold text-gray-600 bg-gray-200 hover:bg-gray-300">Annulla</button>
                        <button id="save-settings-btn"
                            class="px-4 py-2 rounded-lg text-sm font-semibold text-white bg-blue-500 hover:bg-blue-600">Salva</button>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <div id="edit-summary-modal"
        class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-gray-800 dark:text-gray-200">Modifica Dati Riepilogo</h2>
                <button id="close-edit-summary-modal-btn"
                    class="p-2 -mt-2 -mr-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <svg class="w-6 h-6 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <div id="edit-summary-form" class="space-y-4">
            </div>
            <div id="edit-summary-loading" class="hidden text-center p-8">
                <div class="loader mx-auto" style="height: 3rem; width: 3rem;"></div>
                <p class="text-gray-600 dark:text-gray-300 mt-4">Salvataggio in corso...</p>
            </div>
            <div id="edit-summary-buttons" class="flex justify-end space-x-3 mt-6">
                <button id="cancel-edit-summary-btn"
                    class="px-4 py-2 rounded-lg text-gray-600 bg-gray-200 hover:bg-gray-300">Annulla</button>
                <button id="save-summary-changes-btn"
                    class="px-4 py-2 rounded-lg text-white bg-blue-500 hover:bg-blue-600">Salva Modifiche</button>
            </div>
        </div>
    </div>




    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-start">
                <div>
                    <h2 id="modal-title" class="text-xl font-bold text-gray-800 dark:text-gray-200"></h2>
                    <p id="modal-date" class="text-sm text-gray-500 dark:text-gray-400 mb-4"></p>
                </div>
                <button id="close-modal"
                    class="p-2 -mt-2 -mr-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><svg
                        class="w-6 h-6 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg></button>
            </div>
            <div id="modal-description" class="text-gray-700 dark:text-gray-300 whitespace-pre-wrap"></div>
        </div>
    </div>
    <div id="action-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md p-6">
            <div id="action-step-1">
                <h2 class="text-lg font-bold text-gray-800 dark:text-gray-200">Azioni su <span
                        id="selected-dates-count"></span> date</h2>
                <p class="text-sm text-gray-500 mb-4">Scegli l'operazione da eseguire sulle date selezionate.</p>
                <div class="flex justify-end space-x-3 mt-6">
                    <button id="action-edit-btn"
                        class="px-4 py-2 rounded-lg text-white bg-blue-500 hover:bg-blue-600">Modifica</button>
                    <button id="action-delete-btn"
                        class="px-4 py-2 rounded-lg text-white bg-red-500 hover:bg-red-600">Elimina</button>
                    <button id="action-cancel-btn"
                        class="px-4 py-2 rounded-lg text-gray-600 bg-gray-200 hover:bg-gray-300">Annulla</button>
                </div>
            </div>
            <div id="action-step-2" class="hidden">
                <h2 class="text-lg font-bold text-gray-800 dark:text-gray-200">Modifica Eventi</h2>
                <div class="space-y-4 mt-4">
                    <div>
                        <label for="event-type-select"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tipo di Evento</label>
                        <select id="event-type-select"
                            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        </select>
                    </div>
                    <div id="custom-title-wrapper" class="hidden">
                        <label for="event-custom-title-input"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300">Titolo
                            Personalizzato</label>
                        <input type="text" id="event-custom-title-input"
                            class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                    <div>
                        <label for="event-description-input"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300">Descrizione
                            (opzionale)</label>
                        <textarea id="event-description-input" rows="3"
                            class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"></textarea>
                    </div>
                    <div class="flex items-center">
                        <input id="keep-description-checkbox" type="checkbox"
                            class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                        <label for="keep-description-checkbox"
                            class="ml-2 block text-sm text-gray-900 dark:text-gray-300">Mantieni descrizioni
                            esistenti</label>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button id="action-back-btn"
                        class="px-4 py-2 rounded-lg text-gray-600 bg-gray-200 hover:bg-gray-300">Indietro</button>
                    <button id="action-apply-btn"
                        class="px-4 py-2 rounded-lg text-white bg-blue-500 hover:bg-blue-600">Applica Modifiche</button>
                </div>
            </div>




            <div id="action-loading-state" class="hidden text-center p-8">
                <div class="loader mx-auto" style="height: 3rem; width: 3rem;"></div>
                <p class="text-gray-600 dark:text-gray-300 mt-4">Operazione in corso...</p>
            </div>
        </div>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxpmQ7Vj8P2RPrb3IZuFQ5Jct56EZbbb9OjmRnKXJEH-tAn0edwWAnem-1G7l5odikUng/exec';


        // STATO E COSTANTI
        let currentDate = new Date();
        let displayedYear = new Date().getFullYear();
        let allFetchedEvents = [], processedEvents = new Map(), summaryData = {}, yearProcessedEvents = new Map();
        let isSelectionMode = false, selectedDates = new Set();
        let touchStartX = 0, touchEndX = 0;
        let lastActiveView = 'monthly';

        let eventTypeSettings = {}; // Conterrà nomi e colori degli eventi

        // NUOVA FUNZIONE: Calcola la data della Pasqua per un dato anno
        function calcolaPasqua(anno) {
            const a = anno % 19;
            const b = Math.floor(anno / 100);
            const c = anno % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const mese = Math.floor((h + l - 7 * m + 114) / 31);
            const giorno = ((h + l - 7 * m + 114) % 31) + 1;
            return new Date(anno, mese - 1, giorno);
        }



        // NUOVA FUNZIONE: Genera la lista completa delle festività per un anno
        function getFestivita(anno) {
            // Festività fisse
            const fisse = ["01-01", "01-06", "04-25", "05-01", "06-02", "08-15", "11-01", "12-08", "12-25", "12-26"];

            // Aggiunge il 4 ottobre solo dal 2026 in poi
            if (anno >= 2026) {
                fisse.push("10-04");
            }

            // Aggiunge il patrono di Como (se vuoi)
            fisse.push("08-31");

            // Calcola Pasqua e Pasquetta
            const pasqua = calcolaPasqua(anno);
            const pasquetta = new Date(pasqua);
            pasquetta.setDate(pasquetta.getDate() + 1);

            // Formatta le date mobili nel formato "MM-DD"
            const pasquaStr = `${String(pasqua.getMonth() + 1).padStart(2, '0')}-${String(pasqua.getDate()).padStart(2, '0')}`;
            const pasquettaStr = `${String(pasquetta.getMonth() + 1).padStart(2, '0')}-${String(pasquetta.getDate()).padStart(2, '0')}`;

            return new Set([...fisse, pasquaStr, pasquettaStr]);
        }


        // RIFERIMENTI HTML
        let initialLoader, appContainer, errorContainer, monthlyView, annualView, summaryView, monthYearEl, calendarGridEl, prevMonthBtn, nextMonthBtn, todayBtn,
            yearTitleEl, yearGrid, prevYearBtn, nextYearBtn, todayYearBtn, navigationButtonsMonth, managementButtonsMonth, cancelSelectionBtnMonth, proceedSelectionBtnMonth,
            navigationButtonsYear, managementButtonsYear, cancelSelectionBtnYear, proceedSelectionBtnYear,
            actionModal, actionStep1, actionStep2, actionLoadingState, selectedDatesCountEl, actionCancelBtn, actionDeleteBtn, actionEditBtn,
            actionBackBtn, actionApplyBtn, eventTypeSelect, eventDescriptionInput, keepDescriptionCheckbox,
            modal, modalTitle, modalDate, modalDescription, closeModalBtn,
            summaryContent, summaryNotices, backToCalendarBtn, menuMonthBtn, menuMonthContent, menuYearBtn, menuYearContent;

        function getElements() {
            initialLoader = document.getElementById('initial-loader');
            appContainer = document.getElementById('app-container');
            errorContainer = document.getElementById('error-container');
            monthlyView = document.getElementById('monthly-view');
            annualView = document.getElementById('annual-view');
            summaryView = document.getElementById('summary-view');
            monthYearEl = document.getElementById('month-year');
            calendarGridEl = document.getElementById('calendar-grid');
            prevMonthBtn = document.getElementById('prev-month-btn');
            nextMonthBtn = document.getElementById('next-month-btn');
            todayBtn = document.getElementById('today-month-btn');
            yearTitleEl = document.getElementById('year-title');
            yearGrid = document.getElementById('year-grid');
            prevYearBtn = document.getElementById('prev-year-btn');
            nextYearBtn = document.getElementById('next-year-btn');
            todayYearBtn = document.getElementById('today-year-btn');
            navigationButtonsMonth = document.getElementById('navigation-buttons-month');
            managementButtonsMonth = document.getElementById('management-buttons-month');
            cancelSelectionBtnMonth = document.getElementById('cancel-selection-btn-month');
            proceedSelectionBtnMonth = document.getElementById('proceed-selection-btn-month');
            navigationButtonsYear = document.getElementById('navigation-buttons-year');
            managementButtonsYear = document.getElementById('management-buttons-year');
            cancelSelectionBtnYear = document.getElementById('cancel-selection-btn-year');
            proceedSelectionBtnYear = document.getElementById('proceed-selection-btn-year');
            actionModal = document.getElementById('action-modal');
            actionStep1 = document.getElementById('action-step-1');
            actionStep2 = document.getElementById('action-step-2');
            actionLoadingState = document.getElementById('action-loading-state');
            selectedDatesCountEl = document.getElementById('selected-dates-count');
            actionCancelBtn = document.getElementById('action-cancel-btn');
            actionDeleteBtn = document.getElementById('action-delete-btn');
            actionEditBtn = document.getElementById('action-edit-btn');
            actionBackBtn = document.getElementById('action-back-btn');
            actionApplyBtn = document.getElementById('action-apply-btn');
            eventTypeSelect = document.getElementById('event-type-select');
            eventDescriptionInput = document.getElementById('event-description-input');
            keepDescriptionCheckbox = document.getElementById('keep-description-checkbox');
            modal = document.getElementById('event-modal');
            modalTitle = document.getElementById('modal-title');
            modalDate = document.getElementById('modal-date');
            modalDescription = document.getElementById('modal-description');
            closeModalBtn = document.getElementById('close-modal');
            summaryContent = document.getElementById('summary-content');
            summaryNotices = document.getElementById('summary-notices');
            backToCalendarBtn = document.getElementById('back-to-calendar-btn');
            menuMonthBtn = document.getElementById('menu-month-btn');
            menuMonthContent = document.getElementById('menu-month-content');
            menuYearBtn = document.getElementById('menu-year-btn');
            menuYearContent = document.getElementById('menu-year-content');
            menuSummaryBtn = document.getElementById('menu-summary-btn');
            menuSummaryContent = document.getElementById('menu-summary-content');
            editSummaryModal = document.getElementById('edit-summary-modal');
            editSummaryForm = document.getElementById('edit-summary-form');
            editSummaryLoading = document.getElementById('edit-summary-loading');
            closeEditSummaryModalBtn = document.getElementById('close-edit-summary-modal-btn');
            cancelEditSummaryBtn = document.getElementById('cancel-edit-summary-btn');
            saveSummaryChangesBtn = document.getElementById('save-summary-changes-btn');
            editSummaryButtons = document.getElementById('edit-summary-buttons');
            settingsModal = document.getElementById('settings-modal');
            closeSettingsModalBtn = document.getElementById('close-settings-modal-btn');
            settingsEventList = document.getElementById('settings-event-list');
            addEventTypeBtn = document.getElementById('add-event-type-btn');
            cancelSettingsBtn = document.getElementById('cancel-settings-btn');
            saveSettingsBtn = document.getElementById('save-settings-btn');
            settingsLoading = document.getElementById('settings-loading');
            settingsButtons = document.getElementById('settings-buttons');
        }

        function setupEventListeners() {
            menuSummaryBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleMenu(menuSummaryContent); });
            document.getElementById('edit-summary-btn').addEventListener('click', () => { openEditSummaryModal(); closeAllMenus(); });
            closeEditSummaryModalBtn.addEventListener('click', () => editSummaryModal.classList.add('hidden'));
            cancelEditSummaryBtn.addEventListener('click', () => editSummaryModal.classList.add('hidden'));
            saveSummaryChangesBtn.addEventListener('click', saveSummaryChanges);
            prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
            nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
            todayBtn.addEventListener('click', () => { currentDate = new Date(); renderCalendar(); });
            prevYearBtn.addEventListener('click', () => { displayedYear--; renderYear(displayedYear, allFetchedEvents); });
            nextYearBtn.addEventListener('click', () => { displayedYear++; renderYear(displayedYear, allFetchedEvents); });
            todayYearBtn.addEventListener('click', () => { const currentYear = new Date().getFullYear(); if (displayedYear !== currentYear) { displayedYear = currentYear; renderYear(displayedYear, allFetchedEvents); } });
            document.getElementById('manage-btn-month').addEventListener('click', () => { toggleSelectionMode(true); closeAllMenus(); });
            document.getElementById('manage-btn-year').addEventListener('click', () => { toggleSelectionMode(true); closeAllMenus(); });
            document.getElementById('summary-btn').addEventListener('click', () => { showSummaryView(); closeAllMenus(); });
            document.getElementById('toggle-to-annual-view').addEventListener('click', () => { showAnnualView(); closeAllMenus(); });
            document.getElementById('summary-btn-year').addEventListener('click', () => { showSummaryView(); closeAllMenus(); });
            document.getElementById('toggle-to-monthly-view').addEventListener('click', () => { showMonthlyView(displayedYear, currentDate.getMonth()); closeAllMenus(); });
            closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('hidden'); });
            cancelSelectionBtnMonth.addEventListener('click', () => toggleSelectionMode(false));
            cancelSelectionBtnYear.addEventListener('click', () => toggleSelectionMode(false));
            proceedSelectionBtnMonth.addEventListener('click', () => { selectedDatesCountEl.textContent = selectedDates.size; actionStep1.classList.remove('hidden'); actionStep2.classList.add('hidden'); actionModal.classList.remove('hidden'); });
            proceedSelectionBtnYear.addEventListener('click', () => { selectedDatesCountEl.textContent = selectedDates.size; actionStep1.classList.remove('hidden'); actionStep2.classList.add('hidden'); actionModal.classList.remove('hidden'); });
            actionCancelBtn.addEventListener('click', () => actionModal.classList.add('hidden'));
            actionBackBtn.addEventListener('click', () => { actionStep2.classList.add('hidden'); actionStep1.classList.remove('hidden'); });

            actionEditBtn.addEventListener('click', () => {
                const customTitleWrapper = document.getElementById('custom-title-wrapper');
                const customTitleInput = document.getElementById('event-custom-title-input');

                const checkCustomTitleVisibility = () => {
                    if (eventTypeSelect.value === '__FREEFORM__') {
                        customTitleWrapper.classList.remove('hidden');
                    } else {
                        customTitleWrapper.classList.add('hidden');
                    }
                };

                eventTypeSelect.innerHTML = '';
                const freeformOption = document.createElement('option');
                freeformOption.value = '__FREEFORM__';
                freeformOption.textContent = 'Altro (testo libero)...';
                eventTypeSelect.appendChild(freeformOption);

                Object.keys(eventTypeSettings).forEach(tipo => {
                    const option = document.createElement('option');
                    option.value = tipo;
                    option.textContent = tipo;
                    eventTypeSelect.appendChild(option);
                });

                eventTypeSelect.onchange = checkCustomTitleVisibility;
                checkCustomTitleVisibility();

                customTitleInput.value = '';
                eventDescriptionInput.value = '';
                keepDescriptionCheckbox.checked = false;

                actionStep1.classList.add('hidden');
                actionStep2.classList.remove('hidden');
            });


            actionDeleteBtn.addEventListener('click', () => { if (confirm(`Sei sicuro di voler eliminare gli eventi per ${selectedDates.size} date selezionate?`)) { const payload = { action: 'delete', dates: Array.from(selectedDates) }; executeBackendAction(payload); } });

            actionApplyBtn.addEventListener('click', () => {
                let eventType = eventTypeSelect.value;
                if (eventType === '__FREEFORM__') {
                    eventType = document.getElementById('event-custom-title-input').value.trim();
                    if (!eventType) {
                        alert("Per favore, inserisci un titolo per l'evento personalizzato.");
                        return;
                    }
                }

                const payload = {
                    action: 'update',
                    dates: Array.from(selectedDates),
                    eventType: eventType,
                    description: eventDescriptionInput.value,
                    keepDescription: keepDescriptionCheckbox.checked
                };
                executeBackendAction(payload);
            });

            function handleMonthSwipe() { if (touchEndX < touchStartX - 50) { nextMonthBtn.click(); } if (touchEndX > touchStartX + 50) { prevMonthBtn.click(); } }
            function handleYearSwipe() { if (touchEndX < touchStartX - 50) { nextYearBtn.click(); } if (touchEndX > touchStartX + 50) { prevYearBtn.click(); } }
            calendarGridEl.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
            calendarGridEl.addEventListener('touchend', (e) => { touchEndX = e.changedTouches[0].screenX; handleMonthSwipe(); });
            yearGrid.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
            yearGrid.addEventListener('touchend', (e) => { touchEndX = e.changedTouches[0].screenX; handleYearSwipe(); });
            backToCalendarBtn.addEventListener('click', goBackToLastView);
            menuMonthBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleMenu(menuMonthContent); });
            menuYearBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleMenu(menuYearContent); });
            window.addEventListener('click', closeAllMenus);
            document.getElementById('settings-btn-month').addEventListener('click', () => { openSettingsModal(); closeAllMenus(); });
            document.getElementById('settings-btn-year').addEventListener('click', () => { openSettingsModal(); closeAllMenus(); });
            closeSettingsModalBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
            cancelSettingsBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
            addEventTypeBtn.addEventListener('click', addNewEventTypeField);
            saveSettingsBtn.addEventListener('click', saveSettings);
        }

        function hideAllViews() {
            monthlyView.classList.add('hidden');
            annualView.classList.add('hidden');
            summaryView.classList.add('hidden');
        }

        function showMonthlyView(year, month) {
            toggleSelectionMode(false);
            currentDate = new Date(year, month, 15);
            renderCalendar();
            hideAllViews();
            monthlyView.classList.remove('hidden');
        }

        function showAnnualView() {
            toggleSelectionMode(false);
            displayedYear = currentDate.getFullYear();
            renderYear(displayedYear, allFetchedEvents);
            hideAllViews();
            annualView.classList.remove('hidden');
        }

        function showSummaryView() {
            if (!monthlyView.classList.contains('hidden')) {
                lastActiveView = 'monthly';
            } else if (!annualView.classList.contains('hidden')) {
                lastActiveView = 'annual';
            }
            renderSummaryView();
            hideAllViews();
            summaryView.classList.remove('hidden');
        }

        function goBackToLastView() {
            hideAllViews();
            if (lastActiveView === 'annual') {
                annualView.classList.remove('hidden');
            } else {
                monthlyView.classList.remove('hidden');
            }
        }

        function toggleMenu(contentElement) {
            const isHidden = contentElement.classList.contains('hidden');
            closeAllMenus();
            if (isHidden) {
                contentElement.classList.remove('hidden');
                setTimeout(() => contentElement.classList.remove('opacity-0', 'scale-95'), 10);
            }
        }

        function closeAllMenus() {
            [menuMonthContent, menuYearContent, menuSummaryContent].forEach(content => {
                if (content && !content.classList.contains('hidden')) {
                    content.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => content.classList.add('hidden'), 200);
                }
            });
        }

        function renderSummaryView() {
            summaryContent.innerHTML = '';
            summaryNotices.innerHTML = '';
            if (!summaryData || Object.keys(summaryData).length === 0) {
                summaryContent.innerHTML = `<p class="text-gray-500 dark:text-gray-400">Dati di riepilogo non disponibili.</p>`;
                return;
            }

            const table = document.createElement('table');
            table.className = 'w-full text-sm text-left text-gray-500 dark:text-gray-400 table-fixed';

            const thead = `
            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                <tr>
                    <th scope="col" class="w-1/4 px-2 sm:px-4 py-2">Tipo</th>
                    <th scope="col" class="w-1/6 px-2 sm:px-4 py-2 text-center"><span class="sm:hidden">RAP</span><span class="hidden sm:inline">Residui AP</span></th>
                    <th scope="col" class="w-1/6 px-2 sm:px-4 py-2 text-center"><span class="sm:hidden">MAC</span><span class="hidden sm:inline">Maturati</span></th>
                    <th scope="col" class="w-1/6 px-2 sm:px-4 py-2 text-center"><span class="sm:hidden">TOT</span><span class="hidden sm:inline">Totale</span></th>
                    <th scope="col" class="w-1/6 px-2 sm:px-4 py-2 text-center"><span class="sm:hidden">USU</span><span class="hidden sm:inline">Goduti</span></th>
                    <th scope="col" class="w-1/6 px-2 sm:px-4 py-2 text-center"><span class="sm:hidden">PRG</span><span class="hidden sm:inline">Programmati</span></th>
                    <th scope="col" class="w-1/6 px-2 sm:px-4 py-2 text-center font-bold"><span class="sm:hidden">RES</span><span class="hidden sm:inline">Residui</span></th>
                </tr>
            </thead>`;
            table.innerHTML = thead;

            const tbody = document.createElement('tbody');
            const totals = { RAP: 0, MAC: 0, TOT: 0, USU: 0, PRG: 0, RES: 0 };

            for (const tipo in summaryData) {
                const data = summaryData[tipo];
                totals.RAP += parseFloat(data.RAP) || 0;
                totals.MAC += parseFloat(data.MAC) || 0;
                totals.TOT += parseFloat(data.TOT) || 0;
                totals.USU += parseFloat(data.USU) || 0;
                totals.PRG += parseFloat(data.PRG) || 0;
                totals.RES += parseFloat(data.RES) || 0;

                let tipoDisplay = tipo;
                if (tipo === 'Fest. soppr.') {
                    tipoDisplay = `<span class="sm:hidden">Fest.</span><span class="hidden sm:inline">Fest. soppr.</span>`;
                }

                const rowHTML = `
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                    <th scope="row" class="px-2 sm:px-4 py-2 font-medium text-gray-900 whitespace-nowrap dark:text-white">${tipoDisplay}</th>
                    <td class="px-2 sm:px-4 py-2 text-center">${data.RAP}</td>
                    <td class="px-2 sm:px-4 py-2 text-center">${data.MAC}</td>
                    <td class="px-2 sm:px-4 py-2 text-center">${data.TOT}</td>
                    <td class="px-2 sm:px-4 py-2 text-center">${data.USU}</td>
                    <td class="px-2 sm:px-4 py-2 text-center">${data.PRG}</td>
                    <td class="px-2 sm:px-4 py-2 text-center font-bold text-lg">${data.RES}</td>
                </tr>`;
                tbody.innerHTML += rowHTML;
            }
            table.appendChild(tbody);

            const tfoot = document.createElement('tfoot');
            tfoot.className = "bg-gray-100 dark:bg-gray-700 font-bold text-gray-900 dark:text-white";
            const totalsRowHTML = `
            <tr class="border-t-2 border-gray-300 dark:border-gray-600">
                <th scope="row" class="px-2 sm:px-4 py-3">TOTALI</th>
                <td class="px-2 sm:px-4 py-3 text-center">${totals.RAP}</td>
                <td class="px-2 sm:px-4 py-3 text-center">${totals.MAC}</td>
                <td class="px-2 sm:px-4 py-3 text-center">${totals.TOT}</td>
                <td class="px-2 sm:px-4 py-3 text-center">${totals.USU}</td>
                <td class="px-2 sm:px-4 py-3 text-center">${totals.PRG}</td>
                <td class="px-2 sm:px-4 py-3 text-center text-lg">${totals.RES}</td>
            </tr>`;
            tfoot.innerHTML = totalsRowHTML;
            table.appendChild(tfoot);

            summaryContent.appendChild(table);

            const notice1 = document.createElement('p');
            notice1.className = "text-xs text-gray-500 dark:text-gray-400 mt-4";
            notice1.innerHTML = `<strong>Nota:</strong> Verifica la correttezza dei dati nelle colonne <strong>RAP</strong> (Residui Anno Precedente, solo per le ferie) e <strong>MAC</strong> (giorni/permessi maturati nell'anno corrente).`;

            const notice2 = document.createElement('p');
            notice2.className = "text-xs text-gray-500 dark:text-gray-400 mt-2";
            notice2.innerHTML = `<strong>Art. 25:</strong> Se hai usufruito di permessi orari (es. 3 ore), il totale dei giorni interi a disposizione diminuisce. Ricorda di aggiornare manualmente il valore <strong>MAC</strong> per riflettere solo i giorni pieni rimanenti (es. da 3 a 2).`;

            summaryNotices.appendChild(notice1);
            summaryNotices.appendChild(notice2);
        }

        function handleFailure(error) { console.error("Operazione fallita:", error); alert("Si è verificato un errore. Controlla la console per i dettagli."); }
        function processAndRender(eventData) { allFetchedEvents = eventData; processedEvents.clear(); allFetchedEvents.forEach(event => { const date = new Date(event.data.replace(/-/g, '/')); const dateKey = event.data; const eventObj = { ...event, dateObj: date }; if (!processedEvents.has(dateKey)) { processedEvents.set(dateKey, { winner: eventObj, allEvents: [eventObj] }); } else { const existing = processedEvents.get(dateKey); existing.allEvents.push(eventObj); if (new Date(event.ultimaModifica) > new Date(existing.winner.ultimaModifica)) { existing.winner = eventObj; } } }); renderCalendar(); }
        function toggleSelectionMode(enable) { isSelectionMode = enable; const managementButtons = monthlyView.classList.contains('hidden') ? managementButtonsYear : managementButtonsMonth; const navigationButtons = monthlyView.classList.contains('hidden') ? navigationButtonsYear : navigationButtonsMonth; if (enable) { navigationButtons.classList.add('hidden'); managementButtons.classList.remove('hidden'); } else { selectedDates.clear(); navigationButtons.classList.remove('hidden'); managementButtons.classList.add('hidden'); } updateProceedButton(); if (!monthlyView.classList.contains('hidden')) { renderCalendar(); } else { renderYear(displayedYear, allFetchedEvents); } }
        function updateProceedButton() { const proceedBtn = monthlyView.classList.contains('hidden') ? proceedSelectionBtnYear : proceedSelectionBtnMonth; if (selectedDates.size > 0) { proceedBtn.disabled = false; proceedBtn.textContent = `Procedi (${selectedDates.size})`; } else { proceedBtn.disabled = true; proceedBtn.textContent = `Procedi`; } }
        function handleDayClick(dateKey, cellElement) { if (isSelectionMode) { if (selectedDates.has(dateKey)) { selectedDates.delete(dateKey); cellElement.classList.remove('day-selected'); } else { selectedDates.add(dateKey); cellElement.classList.add('day-selected'); } updateProceedButton(); } else { const eventInfo = yearProcessedEvents.get(dateKey) || processedEvents.get(dateKey); if (eventInfo) showModal(eventInfo.winner || eventInfo); } }
        function showModal(eventInfo) { modalTitle.textContent = eventInfo.titolo; modalDate.textContent = eventInfo.dateObj.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }); modalDescription.textContent = eventInfo.descrizione || "Nessuna descrizione fornita."; modal.classList.remove('hidden'); }

        function executeBackendAction(payload) {
            actionStep1.classList.add('hidden');
            actionStep2.classList.add('hidden');
            actionLoadingState.classList.remove('hidden');
            fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'no-cors' })
                .finally(() => {
                    setTimeout(() => {
                        fetch(WEB_APP_URL)
                            .then(response => response.json())
                            .then(data => {
                                summaryData = data.summary;
                                processAndRender(data.events);
                                toggleSelectionMode(false);
                                actionModal.classList.add('hidden');
                                actionLoadingState.classList.add('hidden');
                                actionStep1.classList.remove('hidden');
                            })
                            .catch(handleFailure);
                    }, 2500);
                });
        }



        function renderCalendar() {
            calendarGridEl.innerHTML = '';
            calendarGridEl.style.height = 'calc(6 * 6rem)';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            monthYearEl.textContent = new Date(year, month).toLocaleDateString('it-IT', { month: 'long', year: 'numeric' }).replace(/^\w/, c => c.toUpperCase());
            const firstDayOfMonth = new Date(year, month, 1);
            let startDay = firstDayOfMonth.getDay();
            startDay = startDay === 0 ? 6 : startDay - 1;
            const totalCells = 42;

            for (let i = 0; i < totalCells; i++) {
                const cell = document.createElement('div');
                const cellDate = new Date(year, month, i - startDay + 1);

                if (cellDate.getMonth() !== month) {
                    cell.className = 'invisible';
                } else {
                    cell.className = 'day-cell relative flex items-center justify-center p-1 rounded-lg border border-transparent';

                    const dayNumber = document.createElement('span');
                    dayNumber.className = 'absolute top-1 right-2 font-medium text-gray-700 dark:text-gray-300';
                    dayNumber.textContent = cellDate.getDate();

                    const eventTitle = document.createElement('p');
                    eventTitle.className = 'text-center text-xs sm:text-sm font-semibold line-clamp-2 break-words';

                    cell.appendChild(dayNumber);
                    cell.appendChild(eventTitle);

                    const dateKey = `${cellDate.getFullYear()}-${String(cellDate.getMonth() + 1).padStart(2, '0')}-${String(cellDate.getDate()).padStart(2, '0')}`;

                    const today = new Date();
                    const isToday = cellDate.getDate() === today.getDate() && cellDate.getMonth() === today.getMonth() && cellDate.getFullYear() === today.getFullYear();

                    if (processedEvents.has(dateKey)) {
                        const eventInfo = processedEvents.get(dateKey).winner;
                        const bgColor = eventTypeSettings[eventInfo.titolo] || '#f3f4f6';
                        cell.style.backgroundColor = bgColor;
                        eventTitle.textContent = eventInfo.titolo;
                        const textColor = getContrastingTextColor(bgColor);
                        eventTitle.style.color = textColor;

                        if (!isToday) {
                            dayNumber.style.color = textColor;
                        }

                        if (eventInfo.descrizione && String(eventInfo.descrizione).trim() !== '') {
                            const descIndicator = document.createElement('div');
                            descIndicator.className = 'absolute bottom-1.5 left-1.5 w-1.5 h-1.5 bg-gray-500/50 rounded-full';
                            cell.appendChild(descIndicator);
                        }
                    } else {
                        cell.classList.add('bg-white', 'dark:bg-gray-800', 'border-gray-200', 'dark:border-gray-700');
                        const dayOfWeek = cellDate.getDay();
                        const formattedDateKey = `${String(cellDate.getMonth() + 1).padStart(2, '0')}-${String(cellDate.getDate()).padStart(2, '0')}`;
                        const festivitaAnnuale = getFestivita(cellDate.getFullYear());
                        if (festivitaAnnuale.has(formattedDateKey) || dayOfWeek === 0 || dayOfWeek === 6) {

                            dayNumber.classList.add('text-red-500', 'dark:text-red-400');
                        }
                    }

                    if (isToday) {
                        dayNumber.className = 'absolute top-1 right-2 font-bold w-7 h-7 flex items-center justify-center rounded-full bg-blue-600 text-white';
                    }

                    cell.addEventListener('click', () => handleDayClick(dateKey, cell));
                    if (selectedDates.has(dateKey)) { cell.classList.add('day-selected'); }
                }
                calendarGridEl.appendChild(cell);
            }
        }

        function renderYear(year, allEvents) {
            yearTitleEl.textContent = `Calendario ${year}`;
            yearGrid.innerHTML = '';
            yearProcessedEvents.clear();
            allEvents.forEach(event => { const dateKey = event.data; if (!yearProcessedEvents.has(dateKey)) { yearProcessedEvents.set(dateKey, { ...event, dateObj: new Date(event.data.replace(/-/g, '/')) }); } else { const existing = yearProcessedEvents.get(dateKey); if (new Date(event.ultimaModifica) > new Date(existing.ultimaModifica)) { yearProcessedEvents.set(dateKey, { ...event, dateObj: new Date(event.data.replace(/-/g, '/')) }); } } });
            const today = new Date();
            const festivitaAnnuale = getFestivita(year);

            for (let month = 0; month < 12; month++) {
                const monthContainer = document.createElement('div');
                monthContainer.className = 'bg-white dark:bg-gray-800 p-3 rounded-lg shadow-md';
                const monthName = new Date(year, month).toLocaleString('it-IT', { month: 'long' }).replace(/^\w/, c => c.toUpperCase());
                const monthHeader = document.createElement('button');
                monthHeader.className = 'w-full text-base font-semibold text-center mb-2 p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md text-gray-800 dark:text-gray-200 focus:outline-none';
                monthHeader.textContent = monthName;
                monthHeader.onclick = () => showMonthlyView(year, month);
                monthContainer.appendChild(monthHeader);
                const weekdayGrid = document.createElement('div');
                weekdayGrid.className = 'grid grid-cols-7 text-center text-xs font-bold text-gray-500 dark:text-gray-400';
                ['L', 'M', 'M', 'G', 'V', 'S', 'D'].forEach(d => { const el = document.createElement('div'); el.textContent = d; weekdayGrid.appendChild(el); });
                monthContainer.appendChild(weekdayGrid);
                const dayGrid = document.createElement('div');
                dayGrid.className = 'grid grid-cols-7 gap-1 mt-1';
                const firstDay = new Date(year, month, 1);
                let startDay = firstDay.getDay();
                startDay = startDay === 0 ? 6 : startDay - 1;
                for (let i = 0; i < startDay; i++) { dayGrid.appendChild(document.createElement('div')); }
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const cellDate = new Date(year, month, day);
                    const dateKey = `${cellDate.getFullYear()}-${String(cellDate.getMonth() + 1).padStart(2, '0')}-${String(cellDate.getDate()).padStart(2, '0')}`;
                    const dayCell = document.createElement('div');
                    dayCell.className = 'day-cell h-10 w-full flex items-center justify-center rounded-md transition-colors duration-150 relative cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700';
                    const dayNumberEl = document.createElement('span');
                    dayNumberEl.textContent = day;
                    dayNumberEl.className = 'w-6 h-6 flex items-center justify-center rounded-full text-sm';
                    dayCell.appendChild(dayNumberEl);
                    if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                        dayNumberEl.className += ' bg-blue-600 text-white font-bold';
                    } else {
                        const dayOfWeek = cellDate.getDay();
                        const formattedDateKey = `${String(cellDate.getMonth() + 1).padStart(2, '0')}-${String(cellDate.getDate()).padStart(2, '0')}`;
                        if (festivitaAnnuale.has(formattedDateKey) || dayOfWeek === 0 || dayOfWeek === 6) {
                            dayNumberEl.className += ' text-red-500 dark:text-red-400';
                        } else {
                            dayNumberEl.className += ' text-gray-700 dark:text-gray-300';
                        }
                    }
                    dayCell.addEventListener('click', () => handleDayClick(dateKey, dayCell));
                    if (yearProcessedEvents.has(dateKey)) {
                        const event = yearProcessedEvents.get(dateKey);
                        dayCell.style.backgroundColor = eventTypeSettings[event.titolo] || '#E5E7EB';
                        if (event.descrizione && String(event.descrizione).trim() !== '') {
                            const descIndicator = document.createElement('div');
                            descIndicator.className = 'absolute top-1 right-1 w-1.5 h-1.5 bg-gray-500/50 rounded-full';
                            dayCell.appendChild(descIndicator);
                        }
                    }
                    if (selectedDates.has(dateKey)) {
                        dayCell.classList.add('day-selected');
                    }
                    dayGrid.appendChild(dayCell);
                }
                monthContainer.appendChild(dayGrid);
                yearGrid.appendChild(monthContainer);
            }
        }



        document.addEventListener('DOMContentLoaded', () => {
            getElements();
            setupEventListeners();

            if (!navigator.onLine) {
                initialLoader.style.display = 'none';
                errorContainer.innerHTML = `<p style="color: #ef4444; text-align: center;">Nessuna connessione a Internet.<br>Controlla la tua rete e ricarica la pagina.</p>`;
                errorContainer.style.display = 'flex';
                return;
            }

            fetch(WEB_APP_URL)
                .then(response => {
                    if (!response.ok) throw new Error(`Errore di rete: ${response.statusText}`);
                    return response.json();
                })
                .then(data => {
                    summaryData = data.summary;
                    eventTypeSettings = data.settings.eventTypes;
                    processAndRender(data.events);
                    initialLoader.style.display = 'none';
                    appContainer.classList.remove('hidden');
                })
                .catch(err => {
                    console.error("Errore nel caricamento iniziale:", err);
                    initialLoader.style.display = 'none';
                    errorContainer.innerHTML = `<p style="color: #ef4444; text-align: center;">Impossibile caricare i dati.<br>Verifica la tua connessione e ricarica la pagina.</p>`;
                    errorContainer.style.display = 'flex';
                });
        });



        function openEditSummaryModal() {
            editSummaryForm.innerHTML = '';
            const tipiDaModificare = ["Ferie", "Fest. soppr.", "Art. 25"];

            tipiDaModificare.forEach(tipo => {
                if (summaryData[tipo]) {
                    const data = summaryData[tipo];
                    const fieldset = document.createElement('fieldset');
                    fieldset.className = 'border border-gray-300 dark:border-gray-600 p-3 rounded-lg';

                    const isRapDisabled = tipo === 'Fest. soppr.' || tipo === 'Art. 25';
                    const rapInputHTML = `
                        <div>
                            <label for="summary-rap-${tipo}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">RAP</label>
                            <input type="number" step="1" id="summary-rap-${tipo}" value="${isRapDisabled ? 0 : data.RAP}" 
                                   class="mt-1 w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-500 ${isRapDisabled ? 'bg-gray-100 dark:bg-gray-800 cursor-not-allowed' : ''}" 
                                   ${isRapDisabled ? 'disabled' : ''}>
                        </div>`;

                    fieldset.innerHTML = `
                    <legend class="px-2 font-semibold text-gray-800 dark:text-gray-200">${tipo}</legend>
                    <div class="grid grid-cols-2 gap-4 items-start">
                        ${rapInputHTML}
                        <div>
                            <label for="summary-mac-${tipo}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">MAC</label>
                            <input type="number" step="1" id="summary-mac-${tipo}" value="${data.MAC}" class="mt-1 w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-500">
                        </div>
                    </div>
                `;
                    editSummaryForm.appendChild(fieldset);
                }
            });

            editSummaryModal.classList.remove('hidden');
        }

        function saveSummaryChanges() {
            editSummaryForm.classList.add('hidden');
            editSummaryButtons.classList.add('hidden');
            editSummaryLoading.classList.remove('hidden');

            const tipiDaModificare = ["Ferie", "Fest. soppr.", "Art. 25"];
            const payloadData = {};

            tipiDaModificare.forEach(tipo => {
                const rapInput = document.getElementById(`summary-rap-${tipo}`);
                const macInput = document.getElementById(`summary-mac-${tipo}`);
                payloadData[tipo] = {
                    RAP: rapInput ? rapInput.value : 0,
                    MAC: macInput ? macInput.value : 0
                };
            });

            const payload = {
                action: 'updateSummary',
                data: payloadData
            };

            fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'no-cors' })
                .finally(() => {
                    setTimeout(() => {
                        fetch(WEB_APP_URL)
                            .then(response => response.json())
                            .then(data => {
                                summaryData = data.summary;
                                processAndRender(data.events);
                                renderSummaryView();
                                editSummaryModal.classList.add('hidden');
                            })
                            .catch(handleFailure)
                            .finally(() => {
                                editSummaryLoading.classList.add('hidden');
                                editSummaryForm.classList.remove('hidden');
                                editSummaryButtons.classList.remove('hidden');
                            });
                    }, 2500);
                });
        }

        function getContrastingTextColor(hexColor) {
            if (!hexColor) return '#000000';
            const r = parseInt(hexColor.substr(1, 2), 16);
            const g = parseInt(hexColor.substr(3, 2), 16);
            const b = parseInt(hexColor.substr(5, 2), 16);
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 128) ? '#000000' : '#FFFFFF';
        }

        function openSettingsModal() {
            settingsEventList.innerHTML = '';
            Object.entries(eventTypeSettings).forEach(([nome, colore]) => {
                addNewEventTypeField(nome, colore);
            });
            settingsModal.classList.remove('hidden');
        }


        function addNewEventTypeField(nome = '', colore = '#E5E7EB') {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between space-x-2 event-type-row';
            div.innerHTML = `
                <input type="text" value="${nome}" placeholder="Nome Evento" class="flex-grow p-2 border rounded-md dark:bg-gray-700 dark:border-gray-500 event-type-name min-w-0">
                <div class="flex items-center space-x-2 flex-shrink-0">
                    <input type="color" value="${colore}" class="p-1 h-10 w-10 border-0 rounded-md cursor-pointer event-type-color">
                    <button class="p-2 text-red-500 hover:bg-red-100 rounded-full" onclick="this.closest('.event-type-row').remove()">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>`;
            settingsEventList.appendChild(div);
        }



        function saveSettings() {
            settingsEventList.classList.add('hidden');
            settingsButtons.classList.add('hidden');
            settingsLoading.classList.remove('hidden');

            const newSettings = {};
            document.querySelectorAll('.event-type-row').forEach(row => {
                const nomeInput = row.querySelector('.event-type-name');
                const nome = nomeInput.value.trim();
                const colore = row.querySelector('.event-type-color').value;
                if (nome) {
                    newSettings[nome] = colore;
                }
            });

            const payload = {
                action: 'saveSettings',
                data: {
                    oldTypes: eventTypeSettings,
                    newTypes: newSettings
                }
            };

            fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'no-cors' })
                .finally(() => {
                    setTimeout(() => {
                        fetch(WEB_APP_URL)
                            .then(response => response.json())
                            .then(data => {
                                summaryData = data.summary;
                                eventTypeSettings = data.settings.eventTypes;
                                processAndRender(data.events);
                                settingsModal.classList.add('hidden');
                            })
                            .catch(handleFailure)
                            .finally(() => {
                                settingsLoading.classList.add('hidden');
                                settingsEventList.classList.remove('hidden');
                                settingsButtons.classList.remove('hidden');
                            });
                    }, 3000);
                });
        }
    </script>
</body>

</html>